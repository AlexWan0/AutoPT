<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://unpkg.com/chota@latest">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
	<meta id="jinja_data" data-videos="{{ videos }}">
	<style type="text/css">
		.content_row{
			height:45vh;
			margin:0px;
		}
		.card{
			margin-left:80px;
			margin-right:80px;
			margin-top:10px;
			margin-bottom:10px;
		}
		img{
			max-width:95%;
		}
		.sim_score{
			font-size:80px;
			margin-top:80px;
		}
		.brand{
			margin-left:50px;
			margin-top:40px;
		}
		.tabs{
			margin-right:75px;
			height:60px;
			margin-top:20px;
		}
		.nav{
			margin-bottom: 50px;
			margin-top: 25px;
		}
		table{
			width:100%;
		}
		th{
			border-bottom: 2px solid rgba(0, 0, 0, 0.5);
		}
		td{
			border-bottom: 1px solid rgba(0, 0, 0, 0.5);
		}
		th, td{
			padding-left:20px;
		}
		.table_row{
			color: rgba(0, 0, 0, 0.6);
		}
		.table_cont{
			margin-top:50px;
			margin-left:50px;
			margin-right:50px;
		}
		.difficulty{
			width:20vw;
		}
		#watchout{
			height:20px;
		}
	</style>
	<script type="text/javascript" charset="utf-8">
		$(function(){
			var socket = io();
			socket.on('connect', function() {
				socket.emit('connected', {data: 'I\'m connected!'});
				console.log('aaaaaaaaaaaa');
			});
			function setEleByBinary(binary_data, ele_selector){
				var blob = new Blob([binary_data], {type: "image/jpeg"});
				var urlCreator = window.URL || window.webkitURL;
				var imageUrl = urlCreator.createObjectURL(blob);
				var img = document.querySelector(ele_selector);
				img.src = imageUrl;				
			}
			socket.on('frame', function(data){
				console.log(data['status'])
				if(data['status'] == 'done'){
					$('.sim_score').css('color', 'black');
					$('.sim_score').css('font-size', '30px');
					$('img').hide();
					$('#watchout').text('');
					if(!data['has_next']){
						$('.sim_score').text('Done!');
					}else{
						$('.sim_score').text('Loading...');
						var n = 5;
						var si = setInterval(function(){
							$('.sim_score').text('Starting in '+n+' seconds...');
							n--;

							if(n < 0){
								clearInterval(si);
								$('.sim_score').text('Starting soon...');
							}
						}, 1000);	
					}
				}else{
					setEleByBinary(data['posevid'], '#posevid_ele');
					setEleByBinary(data['webcam'], '#webcam_ele');

					if(data['enum'] >= 1)
						$('#' + (data['enum'] - 1)).css('color', 'rgba(0, 0, 0, 0.6)');
					
					$('#' + data['enum']).css('color', 'black');

					console.log(data['sim']);
					var sim = Math.round(data['sim']*100);
					
					if(Number.isNaN(sim)){
						$('.sim_score').css('color', 'black');
						var n = 5;
						var si = setInterval(function(){
							$('.sim_score').text('Starting in '+n+' seconds...');
							n--;

							if(n < 0){
								clearInterval(si);
								$('.sim_score').text('Starting soon...');
							}
						}, 1000);
						$('.sim_score').css('color', 'black');
						$('.sim_score').css('font-size', '30px');
						$('.stream_imgs').hide();
						$('#watchout').text();
					}else if(data['sim'] == -1){
						$('.sim_score').show();
						$('.stream_imgs').show();
						$('.sim_score').text('No pose detected');
						$('.sim_score').css('color', 'black');
						$('.sim_score').css('font-size', '30px');
						$('#watchout').text();
					}else{
						$('.sim_score').css('font-size', '80px');
						$('.sim_score').show();
						$('.stream_imgs').show();
						$('.sim_score').text(sim);
						if(sim < 60)
							$('.sim_score').css('color', '#cf2415');
						else if(sim < 80)
							$('.sim_score').css('color', '#f2d80f');
						else
							$('.sim_score').css('color', '#64eb10');
						$('#watchout').text('Watch out: ' + data['part']);
					}
				}
			});
		});
	</script>
</head>
<body>
	<nav class='nav'>
		<div class='nav-left'>
			<img style="max-width: 100%;max-height: 9vh;margin-left: 65px;margin-top: 20px;" src="{{url_for('static', filename='logo.png')}}"></img>
		</div>
		<div class='nav-right'>
			<div class="tabs">
				<a class="active" href='/'>Exercise</a>
				<a href='/food'>Nutrition</a>
			</div>
		</div>
	</nav>
	<div class='main_content'>
		<div class='row content_row'>
			<div class='card col-4 is-center'>
				<img class='stream_imgs' id='posevid_ele'></img>
			</div>
			<div class='col text-center'>
				<h1 class='sim_score'>Loading...</h1>
				<h4 id='watchout'></h4>
			</div>
			<div class='card col-4 is-center'>
				<img class='stream_imgs' id='webcam_ele'></img>
			</div>
		</div>
		<div class='table_cont row'>
			<table>
				<col class='title'>
				<col class='difficulty'>
				<tr>
					<th>Title</th>
					<th>Difficulty</th>
				</tr>
				{% for vid in videos %}
				<tr class='table_row' id='{{ loop.index - 1 }}' data-idx='{{ loop.index - 1 }}'>
					<td>{{ vid['vid_name'] }}</td>
					<td>{{ vid['difficulty'] }}</td>
				</tr>
				{% endfor %}
			</table>
		</div>
	</div>
</body>
</html>