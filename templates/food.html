<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://unpkg.com/chota@latest">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
	<meta id="jinja_data" data-videos="{{ videos }}">
	<style type="text/css">
		img{
			max-width:95%;
		}
		.brand{
			margin-left:50px;
			margin-top:40px;
		}
		.tabs{
			margin-right:75px;
			height:60px;
			margin-top:20px;
		}
		.nav{
			margin-bottom: 65px;
			margin-top: 25px;
		}
		.row{
			margin:0;
		}
		.img_cont{
			width:40vw;
			height:40vh;
		}
		.nutr_cont{
			width:40vw;
			height:40vh;
			padding:30px;
			overflow-y: auto;
		}
		h4{
			margin-left:70px;
		}
		.recipes_cont{
			margin-top:50px;
		}
		.food_cont{
			height:40vh;
			padding:30px;
			overflow-y: auto;
		}
		#img_frame{
			max-width:90%;
			cursor:pointer;
		}
		.recipe_cards{
			margin-left:130px;
			margin-bottom:50px;
		}
		#food_input{
			margin-bottom:20px;
		}
	</style>
	<script type="text/javascript" charset="utf-8">
		$(function(){
			var socket = io('http://localhost:5000/food');
			socket.on('connect', function() {
				socket.emit('connected', {data: 'I\'m connected!'});
				console.log('bbbbbbbbbbbb');
			});
			function setEleByBinary(binary_data, ele_selector){
				var blob = new Blob([binary_data], {type: "image/jpeg"});
				var urlCreator = window.URL || window.webkitURL;
				var imageUrl = urlCreator.createObjectURL(blob);
				var img = document.querySelector(ele_selector);
				img.src = imageUrl;				
			}
			socket.on('frame', function(data){
				//console.log(data);
				setEleByBinary(data['img'], '#img_frame');
			});

			var total_nutrients = {'Carbohydrates': 0, 'Calories': 0, 'Sugar': 0, 'Net Carbohydrates': 0};
			var ingredients = [];

			function product_info_succ(res, title){
				console.log(res);

				$('.food_cont').append('<p><i>'+title+'</i></p>');
				ingredients.push(title);

				for (let [key, value] of Object.entries(res['nutrition']['nutrients'])){
					if(value['title'] in total_nutrients){
						total_nutrients[value['title']] += value['percentOfDailyNeeds'];
					}
				}

				$('.nutr_cont').html('<p>Daily Nutrition Percentage:</p>');
				for(let [key, value] of Object.entries(total_nutrients)){
					console.log(key);
					console.log(value);
					$('.nutr_cont').append('<p><b>'+key+': </b>'+value+'%</p>');
				}
				console.log(total_nutrients);

				$('.recipe_cards').html('');

				$.ajax({
					url: "https://api.spoonacular.com/recipes/findByIngredients?apiKey=&ingredients="+encodeURI(ingredients.join())+"&number=10",
					type: 'GET',
					dataType: 'json',
					success: function(recipe_objs){
						for(var ri in recipe_objs){
							var recipe = recipe_objs[ri];
							console.log(recipe);
							$('.recipe_cards').append("<div class='card col-2'><p>"+recipe['title']+"</p><img src='"+recipe['image']+"'></img></div>")
						}
					}
				});
			}

			const capitalize = (s) => {
				if (typeof s !== 'string') return ''
				return s.charAt(0).toUpperCase() + s.slice(1)
			}

			socket.on('return_detection', function(data){
				console.log('return_detection: ' + data['label']);
				var lbl = data['label'];
				if(data['label'] != undefined){
					$.ajax({
						url: "https://api.spoonacular.com/food/products/search?apiKey=&query="+data['label']+"&number=1",
						type: 'GET',
						dataType: 'json',
						success: function(data){
							var id = data['products'][0]["id"]
							console.log(id);
							$.ajax({
								url: "https://api.spoonacular.com/food/products/" + id + "?apiKey=",
								type: 'GET',
								dataType: 'json',
								success: function(res){
									product_info_succ(res, capitalize(lbl))
								}
							});
						}
					});
				}
			});

			$('#img_frame').click(function(){
				socket.emit('detect');
			});

			socket.on('food', function(data){
				console.log(data);

				var upc = data['data'];

				$.ajax({
					url: "https://api.spoonacular.com/food/products/upc/"+upc+"?apiKey=",
					type: 'GET',
					dataType: 'json',
					success: function(res){
						product_info_succ(res, capitalize(res['title']))
					}
				});
			});
		});
	</script>
</head>
<body>
	<nav class='nav'>
		<div class='nav-left'>
			<img style="max-width: 100%;max-height: 9vh;margin-left: 65px;margin-top: 20px;" src="{{url_for('static', filename='logo.png')}}"></img>
		</div>
		<div class='nav-right'>
			<div class="tabs">
				<a href='/'>Exercise</a>
				<a class="active" href='/food'>Nutrition</a>
			</div>
		</div>
	</nav>
	<div class='main_content'>
		<div class='row is-center'>
			<div class='card col-3 food_cont'>
				<p>Food List:</p>
			</div>
			<div class='card col-4 img_cont is-center'>
				<img id='img_frame'></img>
			</div>
			<div class='card col-3 nutr_cont'>
				<p>Daily Nutrition Percentage:</p>
			</div>
		</div>
		<div class='row recipes_cont'>
			<h4>Recipes</h4>
		</div>
		<div class='row recipe_cards'>
		</div>
	</div>
</body>
</html>